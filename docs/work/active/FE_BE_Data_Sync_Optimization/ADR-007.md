# ADR-007: PassSchedule FE-BE 데이터 동기화 전략

## 상태

**제안됨** (Proposed)

## 날짜

2026-01-21

## 컨텍스트

### 현재 상황
- BE: DB + ConcurrentHashMap Write-through 캐시 완료
- FE: localStorage 수동 관리 (passScheduleStore.ts 2,452줄)
- WebSocket: icdStore에서 30ms 실시간 데이터 푸시 (기존 인프라)

### 문제점
1. 페이지 진입마다 서버 API 호출 (2-3초 로딩)
2. 새로고침/탭 전환 시 불필요한 재요청
3. BE 재시작 시 FE localStorage와 불일치 가능성
4. 명확한 캐시 무효화 전략 부재

### 요구사항
- 2번째 방문부터 즉시 로딩 (UX 개선)
- BE 재시작 감지 및 자동 동기화
- 데이터 정합성 보장 (안전 필수 시스템)

## 결정

**Hybrid 동기화 전략 + 선별적 SWR 패턴 적용**

### 데이터 유형별 전략

| 데이터 | Source of Truth | 동기화 전략 | 캐시 |
|--------|-----------------|------------|------|
| 스케줄 목록 (MST) | BE DB | Server-First + 5분 캐시 | O |
| 예측 경로 (DTL) | BE DB | On-Demand | X (용량) |
| 선택된 스케줄 ID | FE localStorage | Cache-First | O |
| TLE 데이터 | BE DB | Server-First | X |
| 실시간 추적 | BE (WebSocket) | Push | X |

### 캐시 무효화 전략

```yaml
자동_무효화:
  - BE 재시작 감지 (버전 0)
  - TLE 업로드 완료 시
  - 5분 TTL 만료 시

수동_무효화:
  - 사용자 새로고침 버튼
```

### 버전 관리

```
BE: writeCounter (AtomicLong) 기반
FE: localStorage에 버전 저장

흐름:
1. FE 페이지 진입 → 캐시 있으면 즉시 표시
2. 백그라운드에서 GET /version 호출
3. 버전 비교 → 다르면 전체 재요청
4. UI 자동 갱신 (Vue 반응성)
```

## 대안

### 대안 1: 전체 Server-First (현재)
- 장점: 항상 최신 데이터
- 단점: 매번 로딩 지연
- 기각 이유: UX 저하

### 대안 2: 전체 SWR
- 장점: 모든 데이터 즉시 로딩
- 단점: stale 데이터 위험, DTL 용량 초과
- 기각 이유: 안전 필수 시스템에 부적합

### 대안 3: HTTP 304/ETag
- 장점: 표준 캐싱, 프록시 캐시 활용
- 단점: BE 수정 범위 큼
- 보류: 향후 고려 가능

### 대안 4: WebSocket Push 전용
- 장점: 실시간 업데이트
- 단점: 모든 데이터에 적용 시 복잡
- 채택: 실시간 데이터에만 (현재 유지)

## 결과

### 긍정적 영향
- 2번째 방문부터 즉시 로딩 (0ms vs 2-3초)
- 서버 부하 감소 (불필요한 API 호출 제거)
- BE 재시작 자동 감지/복구
- 명확한 캐시 정책

### 부정적 영향
- 구현 복잡도 증가 (2-3주 소요)
- 새로운 버전 API 추가
- 마이그레이션 로직 필요

### 위험
- Feature flag로 롤백 가능하도록 구현 필수
- DTL 캐싱 시도 시 localStorage 초과 위험
- 추적 시작 전 Server-First 강제 필수

## 준수 사항

```yaml
필수:
  1. 추적 관련 데이터는 항상 Server-First
  2. DTL 경로 데이터 캐싱 금지
  3. TLE 업로드 후 전체 캐시 무효화
  4. Feature flag로 롤백 가능하게 구현
  5. stale 데이터 사용 시 UI 표시

금지:
  1. 대용량 데이터 localStorage 저장
  2. 캐시만으로 추적 시작
  3. 버전 검증 없이 캐시 사용 (BE 재시작 미감지)
```

## 참고 자료

- [Stale-While-Revalidate - web.dev](https://web.dev/stale-while-revalidate/)
- [TanStack Query](https://tanstack.com/query/latest)
- [SWR by Vercel](https://swr.vercel.app/)
